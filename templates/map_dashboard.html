{% extends "base.html" %}

{% block title %}US Map Dashboard - Prospector{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map-container {
        position: relative;
        height: 80vh;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background: #f8f9fa;
    }
    
    #us-map {
        height: 100%;
        width: 100%;
    }
    
    #state-details-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 350px;
        max-height: calc(100% - 40px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .panel-header {
        background: #2c3e50;
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
    }
    
    .panel-content {
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
    }
    
    .team-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .team-item {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    
    .team-item:last-child {
        border-bottom: none;
    }
    
    .team-name {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .team-county {
        font-size: 12px;
        color: #6c757d;
    }
    
    .team-contact {
        font-size: 12px;
        color: #28a745;
        margin-top: 5px;
    }
    
    .search-form {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .btn-start-search {
        width: 100%;
        background: #28a745;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .btn-start-search:hover {
        background: #218838;
    }
    
    .btn-start-search:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        margin-right: 10px;
        border: 1px solid #ccc;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }
    
    .debug-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .fallback-message {
        text-align: center;
        padding: 50px 20px;
        color: #6c757d;
        font-size: 18px;
    }
    
    .fallback-message h3 {
        color: #dc3545;
        margin-bottom: 20px;
    }
    
    .fallback-message .btn {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>US Overdose Response Team Coverage Map</h1>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
            
            <div id="map-container">
                <div id="us-map"></div>
                
                <div class="debug-info" id="debug-info">
                    Loading map...
                </div>
                
                <div id="fallback-message" class="fallback-message" style="display: none;">
                    <h3>Map Loading Issue</h3>
                    <p>There was a problem loading the interactive map. This could be due to:</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>Network connectivity issues</li>
                        <li>JavaScript being disabled</li>
                        <li>Browser compatibility issues</li>
                    </ul>
                    <br>
                    <a href="{{ url_for('view_results') }}" class="btn btn-primary">View Results Table Instead</a>
                </div>
                
                <div id="state-details-panel">
                    <div class="panel-header">
                        <h4 id="state-name">Select a State</h4>
                    </div>
                    <div class="panel-content">
                        <div id="state-content">
                            <div class="loading">Click on a state to view details</div>
                        </div>
                    </div>
                </div>
                
                <div class="legend">
                    <h6>Coverage Legend</h6>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span>No teams found</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffaa00;"></div>
                        <span>1-2 teams</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff00;"></div>
                        <span>3-5 teams</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff00;"></div>
                        <span>6-10 teams</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #008800;"></div>
                        <span>10+ teams</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Check if Leaflet is available
function checkLeaflet() {
    if (typeof L === 'undefined') {
        updateDebugInfo('ERROR: Leaflet library not loaded. Trying to load it...');
        loadLeafletScript();
        return false;
    }
    return true;
}

function loadLeafletScript() {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = function() {
        updateDebugInfo('Leaflet loaded successfully, retrying map initialization...');
        setTimeout(initializeMap, 1000);
    };
    script.onerror = function() {
        updateDebugInfo('ERROR: Failed to load Leaflet from CDN');
        showFallbackMessage();
    };
    document.head.appendChild(script);
}

let map;
let stateLayers = {};
let selectedState = null;
let stateData = {};
let initializationAttempts = 0;

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking Leaflet...');
    updateDebugInfo('DOM loaded, checking Leaflet availability...');
    
    // Wait a bit for any existing scripts to load
    setTimeout(function() {
        if (checkLeaflet()) {
            initializeMap();
            loadStateData();
        }
    }, 500);
});

function updateDebugInfo(message) {
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo) {
        debugInfo.textContent = message;
        console.log('DEBUG:', message);
    }
}

function showFallbackMessage() {
    const fallback = document.getElementById('fallback-message');
    const debugInfo = document.getElementById('debug-info');
    if (fallback) {
        fallback.style.display = 'block';
    }
    if (debugInfo) {
        debugInfo.style.display = 'none';
    }
}

function initializeMap() {
    initializationAttempts++;
    updateDebugInfo(`Initializing map (attempt ${initializationAttempts})...`);
    
    if (initializationAttempts > 3) {
        updateDebugInfo('ERROR: Too many initialization attempts. Showing fallback.');
        showFallbackMessage();
        return;
    }
    
    try {
        // Check if Leaflet is available
        if (typeof L === 'undefined') {
            updateDebugInfo('ERROR: Leaflet not available. Retrying...');
            setTimeout(initializeMap, 1000);
            return;
        }
        
        updateDebugInfo('Leaflet available, creating map...');
        
        // Initialize the map centered on the US
        map = L.map('us-map').setView([39.8283, -98.5795], 4);
        updateDebugInfo('Map created successfully');
        
        // Add a base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        updateDebugInfo('Tile layer added');
        
        // Create simple state rectangles
        createSimpleStateLayers();
        
    } catch (error) {
        updateDebugInfo('ERROR initializing map: ' + error.message);
        console.error('Map initialization error:', error);
        
        if (initializationAttempts < 3) {
            updateDebugInfo('Retrying in 2 seconds...');
            setTimeout(initializeMap, 2000);
        } else {
            showFallbackMessage();
        }
    }
}

function createSimpleStateLayers() {
    updateDebugInfo('Creating state layers...');
    
    try {
        // Define major states with their approximate bounds
        const states = [
            {code: 'CA', name: 'California', bounds: [[32.5, -124.5], [42, -114.5]]},
            {code: 'TX', name: 'Texas', bounds: [[26, -106.5], [36.5, -93.5]]},
            {code: 'FL', name: 'Florida', bounds: [[24.5, -87.5], [31, -80]]},
            {code: 'NY', name: 'New York', bounds: [[40.5, -79.8], [45, -71.8]]},
            {code: 'PA', name: 'Pennsylvania', bounds: [[39.5, -80.5], [42.5, -74.5]]},
            {code: 'IL', name: 'Illinois', bounds: [[37, -91.5], [42.5, -87.5]]},
            {code: 'OH', name: 'Ohio', bounds: [[38.5, -84.8], [42, -80.5]]},
            {code: 'GA', name: 'Georgia', bounds: [[30.5, -85.6], [35, -80.8]]},
            {code: 'NC', name: 'North Carolina', bounds: [[33.8, -84.3], [36.6, -75.5]]},
            {code: 'MI', name: 'Michigan', bounds: [[41.7, -90.4], [48.2, -82.1]]},
            {code: 'NJ', name: 'New Jersey', bounds: [[38.9, -75.6], [41.4, -73.9]]},
            {code: 'VA', name: 'Virginia', bounds: [[36.5, -83.7], [39.5, -75.2]]},
            {code: 'WA', name: 'Washington', bounds: [[45.5, -124.8], [49, -116.9]]},
            {code: 'AZ', name: 'Arizona', bounds: [[31.3, -114.8], [37, -109]]},
            {code: 'MA', name: 'Massachusetts', bounds: [[41.2, -73.5], [42.9, -69.9]]},
            {code: 'TN', name: 'Tennessee', bounds: [[34.9, -90.3], [36.7, -81.6]]},
            {code: 'IN', name: 'Indiana', bounds: [[37.8, -88.1], [41.8, -84.8]]},
            {code: 'MO', name: 'Missouri', bounds: [[36, -95.8], [40.6, -89.1]]},
            {code: 'MD', name: 'Maryland', bounds: [[37.9, -79.5], [39.7, -75.1]]},
            {code: 'CO', name: 'Colorado', bounds: [[37, -109.1], [41, -102]]},
            {code: 'MN', name: 'Minnesota', bounds: [[43.5, -97.2], [49.4, -89.5]]},
            {code: 'WI', name: 'Wisconsin', bounds: [[42.5, -92.9], [47.1, -86.3]]},
            {code: 'AL', name: 'Alabama', bounds: [[30.2, -88.5], [35, -84.9]]},
            {code: 'SC', name: 'South Carolina', bounds: [[32, -83.4], [35.2, -78.5]]},
            {code: 'LA', name: 'Louisiana', bounds: [[28.9, -94], [33, -88.8]]},
            {code: 'KY', name: 'Kentucky', bounds: [[36.5, -89.6], [39.1, -81.9]]},
            {code: 'OR', name: 'Oregon', bounds: [[42, -124.6], [46.3, -116.5]]},
            {code: 'OK', name: 'Oklahoma', bounds: [[33.6, -103], [37, -94.4]]},
            {code: 'CT', name: 'Connecticut', bounds: [[40.9, -73.7], [42.1, -71.8]]},
            {code: 'IA', name: 'Iowa', bounds: [[40.4, -96.6], [43.5, -90.1]]},
            {code: 'MS', name: 'Mississippi', bounds: [[30.2, -91.7], [34.9, -88.1]]},
            {code: 'AR', name: 'Arkansas', bounds: [[33, -94.6], [36.5, -89.6]]},
            {code: 'KS', name: 'Kansas', bounds: [[37, -102.1], [40, -94.6]]},
            {code: 'UT', name: 'Utah', bounds: [[37, -114.1], [42, -109]]},
            {code: 'NV', name: 'Nevada', bounds: [[35, -120], [42, -114]]},
            {code: 'NM', name: 'New Mexico', bounds: [[31.3, -109.1], [37, -103]]},
            {code: 'NE', name: 'Nebraska', bounds: [[40, -104.1], [43, -95.3]]},
            {code: 'ID', name: 'Idaho', bounds: [[42, -117.2], [49, -111]]},
            {code: 'WV', name: 'West Virginia', bounds: [[37.2, -82.6], [40.6, -77.7]]},
            {code: 'NH', name: 'New Hampshire', bounds: [[42.7, -72.6], [45.3, -70.7]]},
            {code: 'ME', name: 'Maine', bounds: [[43.1, -71.1], [47.5, -66.9]]},
            {code: 'HI', name: 'Hawaii', bounds: [[18.9, -178.3], [28.4, -154.8]]},
            {code: 'RI', name: 'Rhode Island', bounds: [[41.1, -71.9], [42, -71.1]]},
            {code: 'MT', name: 'Montana', bounds: [[44.4, -116.1], [49, -104]]},
            {code: 'DE', name: 'Delaware', bounds: [[38.5, -75.8], [39.8, -75]]},
            {code: 'SD', name: 'South Dakota', bounds: [[42.5, -104.1], [46, -96.4]]},
            {code: 'ND', name: 'North Dakota', bounds: [[45.9, -104.1], [49, -96.6]]},
            {code: 'AK', name: 'Alaska', bounds: [[51.2, -180], [71.4, -130]]},
            {code: 'VT', name: 'Vermont', bounds: [[42.7, -73.4], [45.1, -71.5]]},
            {code: 'WY', name: 'Wyoming', bounds: [[41, -111.1], [45, -104.1]]}
        ];
        
        let createdCount = 0;
        states.forEach(state => {
            try {
                const rect = L.rectangle(state.bounds, {
                    color: 'white',
                    weight: 2,
                    fillColor: '#cccccc',
                    fillOpacity: 0.7
                }).addTo(map);
                
                // Add state label
                const center = rect.getBounds().getCenter();
                const label = L.divIcon({
                    className: 'state-label',
                    html: `<div style="background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 3px; font-size: 10px; font-weight: bold;">${state.code}</div>`,
                    iconSize: [30, 20]
                });
                L.marker(center, {icon: label}).addTo(map);
                
                stateLayers[state.code] = rect;
                createdCount++;
                
                rect.on('click', function() {
                    onStateClick(state.code);
                });
                
                rect.on('mouseover', function() {
                    rect.setStyle({
                        fillOpacity: 0.9,
                        weight: 3
                    });
                });
                
                rect.on('mouseout', function() {
                    if (selectedState !== state.code) {
                        rect.setStyle({
                            fillOpacity: 0.7,
                            weight: 2
                        });
                    }
                });
                
            } catch (error) {
                console.error(`Error creating layer for ${state.code}:`, error);
            }
        });
        
        updateDebugInfo(`Created ${createdCount} state layers successfully`);
        
    } catch (error) {
        updateDebugInfo('ERROR creating state layers: ' + error.message);
        console.error('State layer creation error:', error);
    }
}

function loadStateData() {
    updateDebugInfo('Loading state data...');
    
    fetch('/api/map/states')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stateData = data.data;
                updateMapColors(data.data);
                updateDebugInfo(`Loaded data for ${data.data.length} states`);
            } else {
                updateDebugInfo('Error loading state data: ' + data.error);
                console.error('Error loading state data:', data.error);
            }
        })
        .catch(error => {
            updateDebugInfo('Error fetching state data: ' + error.message);
            console.error('Error fetching state data:', error);
        });
}

function updateMapColors(stateData) {
    stateData.forEach(state => {
        const layer = stateLayers[state.state_code];
        if (layer) {
            const color = getColorByTeamCount(state.team_count);
            layer.setStyle({
                fillColor: color
            });
        }
    });
}

function getColorByTeamCount(count) {
    if (count === 0) return '#ff4444';      // Red - no teams
    if (count <= 2) return '#ffaa00';       // Orange - low coverage
    if (count <= 5) return '#ffff00';       // Yellow - moderate
    if (count <= 10) return '#00ff00';      // Green - good coverage
    return '#008800';                       // Dark green - excellent
}

function onStateClick(stateCode) {
    updateDebugInfo(`Clicked state: ${stateCode}`);
    
    // Reset previous selection
    if (selectedState && stateLayers[selectedState]) {
        stateLayers[selectedState].setStyle({
            fillOpacity: 0.7,
            weight: 2
        });
    }
    
    // Highlight selected state
    if (stateLayers[stateCode]) {
        stateLayers[stateCode].setStyle({
            fillOpacity: 0.9,
            weight: 3
        });
    }
    
    selectedState = stateCode;
    
    // Load state details
    loadStateDetails(stateCode);
}

function loadStateDetails(stateCode) {
    const panel = document.getElementById('state-details-panel');
    const content = document.getElementById('state-content');
    
    panel.style.display = 'block';
    content.innerHTML = '<div class="loading">Loading state details...</div>';
    
    fetch(`/api/map/state/${stateCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStateDetails(data);
            } else {
                content.innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            content.innerHTML = `<div class="error">Error loading state details: ${error.message}</div>`;
        });
}

function displayStateDetails(data) {
    const content = document.getElementById('state-content');
    const stateName = document.getElementById('state-name');
    
    stateName.textContent = data.state.name;
    
    const teams = data.teams;
    const jobs = data.recent_jobs;
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${teams.length}</div>
                <div class="stat-label">Teams Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${jobs.length}</div>
                <div class="stat-label">Recent Searches</div>
            </div>
        </div>
    `;
    
    if (teams.length > 0) {
        html += `
            <h6>Recent Teams Found</h6>
            <div class="team-list">
        `;
        
        teams.slice(0, 5).forEach(team => {
            html += `
                <div class="team-item">
                    <div class="team-name">${team.organization_name}</div>
                    <div class="team-county">${team.county} County</div>
                    ${team.key_personnel_name ? `
                        <div class="team-contact">
                            ${team.key_personnel_name} (${team.key_personnel_title || 'Contact'})
                            ${team.key_personnel_email ? `<br>ð§ ${team.key_personnel_email}` : ''}
                            ${team.key_personnel_phone ? `<br>ð ${team.key_personnel_phone}` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
    } else {
        html += `<p>No teams found yet for this state.</p>`;
    }
    
    html += `
        <div class="search-form">
            <h6>Start New Search</h6>
            <input type="text" id="search-query" class="search-input" 
                   placeholder="e.g., overdose response team, harm reduction" 
                   value="overdose response team">
            <button class="btn-start-search" onclick="startSearch('${data.state.abbreviation}')">
                Start Search for ${data.state.name}
            </button>
        </div>
    `;
    
    content.innerHTML = html;
}

function startSearch(stateCode) {
    const searchQuery = document.getElementById('search-query').value;
    const button = document.querySelector('.btn-start-search');
    
    button.disabled = true;
    button.textContent = 'Starting Search...';
    
    fetch(`/api/map/start-search/${stateCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            search_query: searchQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.textContent = 'Search Started!';
            button.style.background = '#28a745';
            
            // Redirect to job status page after a short delay
            setTimeout(() => {
                window.location.href = `/job/${data.job_id}`;
            }, 1500);
        } else {
            button.textContent = 'Error: ' + data.error;
            button.style.background = '#dc3545';
            setTimeout(() => {
                button.disabled = false;
                button.textContent = `Start Search for ${selectedState}`;
                button.style.background = '#28a745';
            }, 3000);
        }
    })
    .catch(error => {
        button.textContent = 'Error: ' + error.message;
        button.style.background = '#dc3545';
        setTimeout(() => {
            button.disabled = false;
            button.textContent = `Start Search for ${selectedState}`;
            button.style.background = '#28a745';
        }, 3000);
    });
}
</script>
{% endblock %}
