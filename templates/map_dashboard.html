{% extends "base.html" %}

{% block title %}US Map Dashboard - Prospector{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    /* Simple map styles */
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div id="map-container" style="height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; z-index: 9999; background: #e9ecef; border: 5px solid #007bff;">
    <div style="position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 4px; font-size: 16px; z-index: 1001; border: 2px solid #007bff; font-weight: bold;">
        üó∫Ô∏è MAP TEST - FULL SCREEN
    </div>
    <div id="us-map" style="height: 100%; width: 100%;"></div>
    
    <div style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 4px; font-size: 14px; z-index: 1001;">
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Simple map test - loading...');

// Simple map initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing simple map...');
    
    // Wait for Leaflet to load
    setTimeout(function() {
        if (typeof L !== 'undefined') {
            console.log('Leaflet available, creating map...');
            createSimpleMap();
        } else {
            console.log('Loading Leaflet manually...');
            loadLeafletManually();
        }
    }, 1000);
    
    function loadLeafletManually() {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = function() {
            console.log('Leaflet loaded manually, creating map...');
            createSimpleMap();
        };
        script.onerror = function() {
            console.error('Failed to load Leaflet');
        };
        document.head.appendChild(script);
    }
    
    function createSimpleMap() {
        try {
            console.log('Creating simple map...');
            
            // Create the map
            const map = L.map('us-map').setView([39.8283, -98.5795], 4);
            console.log('Map created successfully');
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            console.log('Tile layer added');
            
            // Add a simple marker to test
            L.marker([39.8283, -98.5795]).addTo(map)
                .bindPopup('Map is working! This is the center of the US.')
                .openPopup();
            console.log('Test marker added');
            
        } catch (error) {
            console.error('Error creating map:', error);
        }
    }
});
</script>
{% endblock %}



let map;
let stateLayers = {};
let selectedState = null;
let stateData = {};



function updateDebugInfo(message) {
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo) {
        debugInfo.textContent = message;
        console.log('DEBUG:', message);
    }
}

function showFallbackMessage() {
    const fallback = document.getElementById('fallback-message');
    const debugInfo = document.getElementById('debug-info');
    if (fallback) {
        fallback.style.display = 'block';
    }
    if (debugInfo) {
        debugInfo.style.display = 'none';
    }
}

function initializeMap() {
    updateDebugInfo('Initializing map...');
    
    try {
        // Check if Leaflet is available
        if (typeof L === 'undefined') {
            updateDebugInfo('ERROR: Leaflet library not loaded');
            showFallbackMessage();
            return;
        }
        
        updateDebugInfo('Leaflet available, creating map...');
        
        // Hide the placeholder
        const placeholder = document.getElementById('map-placeholder');
        if (placeholder) {
            placeholder.style.display = 'none';
        }
        
        // Initialize the map centered on the US
        map = L.map('us-map').setView([39.8283, -98.5795], 4);
        updateDebugInfo('Map created successfully');
        
        // Add a base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        updateDebugInfo('Tile layer added');
        
        // Add state markers with organization counts
        createStateMarkers();
        
    } catch (error) {
        updateDebugInfo('ERROR initializing map: ' + error.message);
        console.error('Map initialization error:', error);
        showFallbackMessage();
    }
}

function createStateMarkers() {
    updateDebugInfo('Creating state markers...');
    
    try {
        // Define state centers with approximate coordinates
        const stateCenters = {
            'CA': [36.7783, -119.4179], 'TX': [31.9686, -99.9018], 'FL': [27.6648, -81.5158],
            'NY': [42.1657, -74.9481], 'PA': [40.5908, -77.2098], 'IL': [40.6331, -89.3985],
            'OH': [40.4173, -82.9071], 'GA': [32.1656, -82.9001], 'NC': [35.7596, -79.0193],
            'MI': [44.3148, -85.6024], 'NJ': [40.0583, -74.4057], 'VA': [37.7693, -78.1700],
            'WA': [47.4009, -121.4905], 'AZ': [33.7298, -111.4312], 'MA': [42.2304, -71.5301],
            'TN': [35.7478, -86.6923], 'IN': [39.8494, -86.2583], 'MO': [38.4561, -92.2884],
            'MD': [39.0639, -76.8021], 'CO': [39.5501, -105.7821], 'MN': [46.7296, -94.6859],
            'WI': [44.2685, -89.6165], 'AL': [32.8067, -86.7911], 'SC': [33.8569, -80.9450],
            'LA': [31.1695, -91.8678], 'KY': [37.6681, -84.6701], 'OR': [44.5720, -122.0709],
            'OK': [35.5653, -96.9289], 'CT': [41.6032, -73.0877], 'IA': [42.0329, -93.9008],
            'MS': [32.7416, -89.6787], 'AR': [34.9697, -92.3731], 'KS': [38.5111, -96.8005],
            'UT': [39.3210, -111.0937], 'NV': [38.8026, -116.4194], 'NM': [34.5199, -105.8701],
            'NE': [41.4925, -99.9018], 'ID': [44.2405, -114.4788], 'WV': [38.5976, -80.4549],
            'NH': [43.1939, -71.5724], 'ME': [44.6939, -69.3819], 'HI': [19.8968, -155.5828],
            'RI': [41.6809, -71.5118], 'MT': [46.8797, -110.3626], 'DE': [38.9108, -75.5277],
            'SD': [44.2998, -99.4388], 'ND': [47.5515, -101.0020], 'AK': [63.5887, -154.4931],
            'VT': [44.0459, -72.7107], 'WY': [42.7475, -107.2085]
        };
        
        let createdCount = 0;
        Object.keys(stateCenters).forEach(stateCode => {
            try {
                const coords = stateCenters[stateCode];
                const count = stateData[stateCode] ? stateData[stateCode].team_count : 0;
                
                // Create marker with organization count
                const marker = L.marker(coords).addTo(map);
                
                // Add popup with state info
                marker.bindPopup(`
                    <strong>${stateCode}</strong><br>
                    Organizations found: <strong>${count}</strong>
                `);
                
                // Add click handler
                marker.on('click', function() {
                    onStateClick(stateCode);
                });
                
                stateLayers[stateCode] = marker;
                createdCount++;
                
            } catch (error) {
                console.error(`Error creating marker for ${stateCode}:`, error);
            }
        });
        
        updateDebugInfo(`Created ${createdCount} state markers successfully`);
        
    } catch (error) {
        updateDebugInfo('ERROR creating state markers: ' + error.message);
        console.error('State marker creation error:', error);
    }
}

function loadStateData() {
    updateDebugInfo('Loading state data...');
    
    fetch('/api/map/states')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stateData = data.data;
                updateMapColors(data.data);
                updateDebugInfo(`Loaded data for ${data.data.length} states`);
            } else {
                updateDebugInfo('Error loading state data: ' + data.error);
                console.error('Error loading state data:', data.error);
            }
        })
        .catch(error => {
            updateDebugInfo('Error fetching state data: ' + error.message);
            console.error('Error fetching state data:', error);
        });
}

function updateMapColors(stateData) {
    // Convert stateData array to object for easier lookup
    const stateDataObj = {};
    stateData.forEach(state => {
        stateDataObj[state.state_code] = state;
    });
    
    // Update markers with new data
    Object.keys(stateLayers).forEach(stateCode => {
        const marker = stateLayers[stateCode];
        const stateInfo = stateDataObj[stateCode];
        
        if (marker && stateInfo) {
            const count = stateInfo.team_count || 0;
            
            // Update popup with new count
            marker.bindPopup(`
                <strong>${stateCode}</strong><br>
                Organizations found: <strong>${count}</strong>
            `);
        }
    });
}



function onStateClick(stateCode) {
    updateDebugInfo(`Clicked state: ${stateCode}`);
    
    // Reset previous selection
    if (selectedState && stateLayers[selectedState]) {
        stateLayers[selectedState].setStyle({
            fillOpacity: 0.7,
            weight: 2
        });
    }
    
    // Highlight selected state
    if (stateLayers[stateCode]) {
        stateLayers[stateCode].setStyle({
            fillOpacity: 0.9,
            weight: 3
        });
    }
    
    selectedState = stateCode;
    
    // Load state details
    loadStateDetails(stateCode);
}

function loadStateDetails(stateCode) {
    const panel = document.getElementById('state-details-panel');
    const content = document.getElementById('state-content');
    
    panel.style.display = 'block';
    content.innerHTML = '<div class="loading">Loading state details...</div>';
    
    fetch(`/api/map/state/${stateCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStateDetails(data);
            } else {
                content.innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            content.innerHTML = `<div class="error">Error loading state details: ${error.message}</div>`;
        });
}

function displayStateDetails(data) {
    const content = document.getElementById('state-content');
    const stateName = document.getElementById('state-name');
    
    stateName.textContent = data.state.name;
    
    const teams = data.teams;
    const jobs = data.recent_jobs;
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${teams.length}</div>
                <div class="stat-label">Teams Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${jobs.length}</div>
                <div class="stat-label">Recent Searches</div>
            </div>
        </div>
    `;
    
    if (teams.length > 0) {
        html += `
            <h6>Recent Teams Found</h6>
            <div class="team-list">
        `;
        
        teams.slice(0, 5).forEach(team => {
            html += `
                <div class="team-item">
                    <div class="team-name">${team.organization_name}</div>
                    <div class="team-county">${team.county} County</div>
                    ${team.key_personnel_name ? `
                        <div class="team-contact">
                            ${team.key_personnel_name} (${team.key_personnel_title || 'Contact'})
                            ${team.key_personnel_email ? `<br>üìß ${team.key_personnel_email}` : ''}
                            ${team.key_personnel_phone ? `<br>üìû ${team.key_personnel_phone}` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
    } else {
        html += `<p>No teams found yet for this state.</p>`;
    }
    
    html += `
        <div class="search-form">
            <h6>Start New Search</h6>
            <input type="text" id="search-query" class="search-input" 
                   placeholder="e.g., overdose response team, harm reduction" 
                   value="overdose response team">
            <button class="btn-start-search" onclick="startSearch('${data.state.abbreviation}')">
                Start Search for ${data.state.name}
            </button>
        </div>
    `;
    
    content.innerHTML = html;
}

function startSearch(stateCode) {
    const searchQuery = document.getElementById('search-query').value;
    const button = document.querySelector('.btn-start-search');
    
    button.disabled = true;
    button.textContent = 'Starting Search...';
    
    fetch(`/api/map/start-search/${stateCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            search_query: searchQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.textContent = 'Search Started!';
            button.style.background = '#28a745';
            
            // Redirect to job status page after a short delay
            setTimeout(() => {
                window.location.href = `/job/${data.job_id}`;
            }, 1500);
        } else {
            button.textContent = 'Error: ' + data.error;
            button.style.background = '#dc3545';
            setTimeout(() => {
                button.disabled = false;
                button.textContent = `Start Search for ${selectedState}`;
                button.style.background = '#28a745';
            }, 3000);
        }
    })
    .catch(error => {
        button.textContent = 'Error: ' + error.message;
        button.style.background = '#dc3545';
        setTimeout(() => {
            button.disabled = false;
            button.textContent = `Start Search for ${selectedState}`;
            button.style.background = '#28a745';
        }, 3000);
    });
}
</script>
{% endblock %}
