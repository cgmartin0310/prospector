{% extends "base.html" %}

{% block title %}US Map Dashboard - Prospector{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    #map-container {
        position: relative;
        height: 80vh;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background: #f8f9fa;
        min-height: 600px;
        border: 3px solid #007bff;
        background: #e9ecef;
    }
    
    #us-map {
        height: 100%;
        width: 100%;
    }
    
    #state-details-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 350px;
        max-height: calc(100% - 40px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .panel-header {
        background: #2c3e50;
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
    }
    
    .panel-content {
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
    }
    
    .team-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .team-item {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    
    .team-item:last-child {
        border-bottom: none;
    }
    
    .team-name {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .team-county {
        font-size: 12px;
        color: #6c757d;
    }
    
    .team-contact {
        font-size: 12px;
        color: #28a745;
        margin-top: 5px;
    }
    
    .search-form {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .btn-start-search {
        width: 100%;
        background: #28a745;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .btn-start-search:hover {
        background: #218838;
    }
    
    .btn-start-search:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        margin-right: 10px;
        border: 1px solid #ccc;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }
    
    .debug-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .fallback-message {
        text-align: center;
        padding: 50px 20px;
        color: #6c757d;
        font-size: 18px;
    }
    
    .fallback-message h3 {
        color: #dc3545;
        margin-bottom: 20px;
    }
    
    .fallback-message .btn {
        margin-top: 20px;
    }
    
    .simple-test {
        background: #e9ecef;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        text-align: center;
    }
    
    .test-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px;
    }
    
    .test-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
    }
    
    .test-success {
        background: #d4edda;
        color: #155724;
    }
    
    .test-error {
        background: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>US Overdose Response Team Coverage Map</h1>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
            
            <!-- Simple JavaScript Test -->
            <div class="simple-test">
                <h4>JavaScript Test</h4>
                <p>Let's test if JavaScript is working on Render:</p>
                <button class="test-button" id="test-js-btn">Test Basic JavaScript</button>
                <button class="test-button" id="test-fetch-btn">Test API Fetch</button>
                <button class="test-button" id="test-leaflet-btn">Test Leaflet Library</button>
                <button class="test-button" id="test-map-route-btn">Test Map Route</button>
                <div id="test-results"></div>
            </div>
            
            <div id="map-container">
                <div style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 3px; font-size: 12px; z-index: 1001;">
                    Map Container Active
                </div>
                <div id="us-map"></div>
                
                <div class="debug-info" id="debug-info">
                    Loading map...
                </div>
                
                <div id="fallback-message" class="fallback-message" style="display: none;">
                    <h3>Map Loading Issue</h3>
                    <p>There was a problem loading the interactive map. This could be due to:</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>Network connectivity issues</li>
                        <li>JavaScript being disabled</li>
                        <li>Browser compatibility issues</li>
                    </ul>
                    <br>
                    <a href="{{ url_for('view_results') }}" class="btn btn-primary">View Results Table Instead</a>
                </div>
                
                <div id="state-details-panel">
                    <div class="panel-header">
                        <h4 id="state-name">Select a State</h4>
                    </div>
                    <div class="panel-content">
                        <div id="state-content">
                            <div class="loading">Click on a state to view details</div>
                        </div>
                    </div>
                </div>
                
                <div class="legend">
                    <h6>US Map with Organization Counts</h6>
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        Click on any state marker to see details and start a search
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Map dashboard script loaded!');

// Simple test functions
function testBasicJS() {
    const results = document.getElementById('test-results');
    try {
        const testElement = document.createElement('div');
        testElement.textContent = 'JavaScript is working!';
        results.innerHTML = '<div class="test-result test-success">‚úÖ Basic JavaScript is working</div>';
    } catch (error) {
        results.innerHTML = '<div class="test-result test-error">‚ùå Basic JavaScript failed: ' + error.message + '</div>';
    }
}

function testFetch() {
    const results = document.getElementById('test-results');
    results.innerHTML = '<div class="test-result">üîÑ Testing API fetch...</div>';
    
    // Test the map states API endpoint
    fetch('/api/map/states')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                results.innerHTML = '<div class="test-result test-success">‚úÖ API fetch working! Got ' + (data.data ? data.data.length : 0) + ' states</div>';
            } else {
                results.innerHTML = '<div class="test-result test-error">‚ùå API returned error: ' + (data.error || 'Unknown error') + '</div>';
            }
        })
        .catch(error => {
            results.innerHTML = '<div class="test-result test-error">‚ùå API fetch failed: ' + error.message + '</div>';
        });
}

function testLeaflet() {
    const results = document.getElementById('test-results');
    if (typeof L === 'undefined') {
        results.innerHTML = '<div class="test-result test-error">‚ùå Leaflet library not loaded</div>';
    } else {
        results.innerHTML = '<div class="test-result test-success">‚úÖ Leaflet library is available</div>';
    }
}

function testMapRoute() {
    const results = document.getElementById('test-results');
    results.innerHTML = '<div class="test-result">üîÑ Testing map route...</div>';
    
    // Test if we can access the map route
    fetch('/map')
        .then(response => {
            if (response.ok) {
                results.innerHTML = '<div class="test-result test-success">‚úÖ Map route is accessible</div>';
            } else {
                results.innerHTML = '<div class="test-result test-error">‚ùå Map route returned HTTP ' + response.status + '</div>';
            }
        })
        .catch(error => {
            results.innerHTML = '<div class="test-result test-error">‚ùå Map route test failed: ' + error.message + '</div>';
        });
}

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up test buttons...');
    console.log('Test buttons should be working now!');
    
    // Set up test button event listeners
    const testJSBtn = document.getElementById('test-js-btn');
    const testFetchBtn = document.getElementById('test-fetch-btn');
    const testLeafletBtn = document.getElementById('test-leaflet-btn');
    const testMapRouteBtn = document.getElementById('test-map-route-btn');
    
    if (testJSBtn) {
        testJSBtn.addEventListener('click', testBasicJS);
        console.log('Test JS button listener added');
    }
    
    if (testFetchBtn) {
        testFetchBtn.addEventListener('click', testFetch);
        console.log('Test Fetch button listener added');
    }
    
    if (testLeafletBtn) {
        testLeafletBtn.addEventListener('click', testLeaflet);
        console.log('Test Leaflet button listener added');
    }
    
    if (testMapRouteBtn) {
        testMapRouteBtn.addEventListener('click', testMapRoute);
        console.log('Test Map Route button listener added');
    }
    
    // Wait a moment for Leaflet to be fully loaded, then initialize map
    updateDebugInfo('DOM loaded, waiting for Leaflet...');
    
    // Try multiple times to load Leaflet
    let leafletAttempts = 0;
    const maxAttempts = 5;
    
    function tryLoadLeaflet() {
        leafletAttempts++;
        updateDebugInfo(`Checking for Leaflet (attempt ${leafletAttempts}/${maxAttempts})...`);
        
        if (typeof L !== 'undefined') {
            updateDebugInfo('Leaflet available, initializing map...');
            initializeMap();
            loadStateData();
        } else if (leafletAttempts < maxAttempts) {
            updateDebugInfo(`Leaflet not ready, retrying in 500ms...`);
            setTimeout(tryLoadLeaflet, 500);
        } else {
            updateDebugInfo('ERROR: Leaflet failed to load after multiple attempts');
            // Try loading Leaflet manually
            loadLeafletManually();
        }
    }
    
    function loadLeafletManually() {
        updateDebugInfo('Attempting to load Leaflet manually...');
        
        // Add CSS first
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css';
        document.head.appendChild(link);
        
        // Then add script
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        script.onload = function() {
            updateDebugInfo('Leaflet loaded manually, initializing map...');
            initializeMap();
            loadStateData();
        };
        script.onerror = function() {
            updateDebugInfo('ERROR: Failed to load Leaflet from CDN');
            showFallbackMessage();
        };
        document.head.appendChild(script);
    }
    
    setTimeout(tryLoadLeaflet, 500);
});



let map;
let stateLayers = {};
let selectedState = null;
let stateData = {};



function updateDebugInfo(message) {
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo) {
        debugInfo.textContent = message;
        console.log('DEBUG:', message);
    }
}

function showFallbackMessage() {
    const fallback = document.getElementById('fallback-message');
    const debugInfo = document.getElementById('debug-info');
    if (fallback) {
        fallback.style.display = 'block';
    }
    if (debugInfo) {
        debugInfo.style.display = 'none';
    }
}

function initializeMap() {
    updateDebugInfo('Initializing map...');
    
    try {
        // Check if Leaflet is available
        if (typeof L === 'undefined') {
            updateDebugInfo('ERROR: Leaflet library not loaded');
            showFallbackMessage();
            return;
        }
        
        updateDebugInfo('Leaflet available, creating map...');
        
        // Initialize the map centered on the US
        map = L.map('us-map').setView([39.8283, -98.5795], 4);
        updateDebugInfo('Map created successfully');
        
        // Add a base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        updateDebugInfo('Tile layer added');
        
        // Add state markers with organization counts
        createStateMarkers();
        
    } catch (error) {
        updateDebugInfo('ERROR initializing map: ' + error.message);
        console.error('Map initialization error:', error);
        showFallbackMessage();
    }
}

function createStateMarkers() {
    updateDebugInfo('Creating state markers...');
    
    try {
        // Define state centers with approximate coordinates
        const stateCenters = {
            'CA': [36.7783, -119.4179], 'TX': [31.9686, -99.9018], 'FL': [27.6648, -81.5158],
            'NY': [42.1657, -74.9481], 'PA': [40.5908, -77.2098], 'IL': [40.6331, -89.3985],
            'OH': [40.4173, -82.9071], 'GA': [32.1656, -82.9001], 'NC': [35.7596, -79.0193],
            'MI': [44.3148, -85.6024], 'NJ': [40.0583, -74.4057], 'VA': [37.7693, -78.1700],
            'WA': [47.4009, -121.4905], 'AZ': [33.7298, -111.4312], 'MA': [42.2304, -71.5301],
            'TN': [35.7478, -86.6923], 'IN': [39.8494, -86.2583], 'MO': [38.4561, -92.2884],
            'MD': [39.0639, -76.8021], 'CO': [39.5501, -105.7821], 'MN': [46.7296, -94.6859],
            'WI': [44.2685, -89.6165], 'AL': [32.8067, -86.7911], 'SC': [33.8569, -80.9450],
            'LA': [31.1695, -91.8678], 'KY': [37.6681, -84.6701], 'OR': [44.5720, -122.0709],
            'OK': [35.5653, -96.9289], 'CT': [41.6032, -73.0877], 'IA': [42.0329, -93.9008],
            'MS': [32.7416, -89.6787], 'AR': [34.9697, -92.3731], 'KS': [38.5111, -96.8005],
            'UT': [39.3210, -111.0937], 'NV': [38.8026, -116.4194], 'NM': [34.5199, -105.8701],
            'NE': [41.4925, -99.9018], 'ID': [44.2405, -114.4788], 'WV': [38.5976, -80.4549],
            'NH': [43.1939, -71.5724], 'ME': [44.6939, -69.3819], 'HI': [19.8968, -155.5828],
            'RI': [41.6809, -71.5118], 'MT': [46.8797, -110.3626], 'DE': [38.9108, -75.5277],
            'SD': [44.2998, -99.4388], 'ND': [47.5515, -101.0020], 'AK': [63.5887, -154.4931],
            'VT': [44.0459, -72.7107], 'WY': [42.7475, -107.2085]
        };
        
        let createdCount = 0;
        Object.keys(stateCenters).forEach(stateCode => {
            try {
                const coords = stateCenters[stateCode];
                const count = stateData[stateCode] ? stateData[stateCode].team_count : 0;
                
                // Create marker with organization count
                const marker = L.marker(coords).addTo(map);
                
                // Add popup with state info
                marker.bindPopup(`
                    <strong>${stateCode}</strong><br>
                    Organizations found: <strong>${count}</strong>
                `);
                
                // Add click handler
                marker.on('click', function() {
                    onStateClick(stateCode);
                });
                
                stateLayers[stateCode] = marker;
                createdCount++;
                
            } catch (error) {
                console.error(`Error creating marker for ${stateCode}:`, error);
            }
        });
        
        updateDebugInfo(`Created ${createdCount} state markers successfully`);
        
    } catch (error) {
        updateDebugInfo('ERROR creating state markers: ' + error.message);
        console.error('State marker creation error:', error);
    }
}

function loadStateData() {
    updateDebugInfo('Loading state data...');
    
    fetch('/api/map/states')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stateData = data.data;
                updateMapColors(data.data);
                updateDebugInfo(`Loaded data for ${data.data.length} states`);
            } else {
                updateDebugInfo('Error loading state data: ' + data.error);
                console.error('Error loading state data:', data.error);
            }
        })
        .catch(error => {
            updateDebugInfo('Error fetching state data: ' + error.message);
            console.error('Error fetching state data:', error);
        });
}

function updateMapColors(stateData) {
    stateData.forEach(state => {
        const layer = stateLayers[state.state_code];
        if (layer) {
            const color = getColorByTeamCount(state.team_count);
            layer.setStyle({
                fillColor: color
            });
        }
    });
}

function getColorByTeamCount(count) {
    if (count === 0) return '#ff4444';      // Red - no teams
    if (count <= 2) return '#ffaa00';       // Orange - low coverage
    if (count <= 5) return '#ffff00';       // Yellow - moderate
    if (count <= 10) return '#00ff00';      // Green - good coverage
    return '#008800';                       // Dark green - excellent
}

function onStateClick(stateCode) {
    updateDebugInfo(`Clicked state: ${stateCode}`);
    
    // Reset previous selection
    if (selectedState && stateLayers[selectedState]) {
        stateLayers[selectedState].setStyle({
            fillOpacity: 0.7,
            weight: 2
        });
    }
    
    // Highlight selected state
    if (stateLayers[stateCode]) {
        stateLayers[stateCode].setStyle({
            fillOpacity: 0.9,
            weight: 3
        });
    }
    
    selectedState = stateCode;
    
    // Load state details
    loadStateDetails(stateCode);
}

function loadStateDetails(stateCode) {
    const panel = document.getElementById('state-details-panel');
    const content = document.getElementById('state-content');
    
    panel.style.display = 'block';
    content.innerHTML = '<div class="loading">Loading state details...</div>';
    
    fetch(`/api/map/state/${stateCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStateDetails(data);
            } else {
                content.innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            content.innerHTML = `<div class="error">Error loading state details: ${error.message}</div>`;
        });
}

function displayStateDetails(data) {
    const content = document.getElementById('state-content');
    const stateName = document.getElementById('state-name');
    
    stateName.textContent = data.state.name;
    
    const teams = data.teams;
    const jobs = data.recent_jobs;
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${teams.length}</div>
                <div class="stat-label">Teams Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${jobs.length}</div>
                <div class="stat-label">Recent Searches</div>
            </div>
        </div>
    `;
    
    if (teams.length > 0) {
        html += `
            <h6>Recent Teams Found</h6>
            <div class="team-list">
        `;
        
        teams.slice(0, 5).forEach(team => {
            html += `
                <div class="team-item">
                    <div class="team-name">${team.organization_name}</div>
                    <div class="team-county">${team.county} County</div>
                    ${team.key_personnel_name ? `
                        <div class="team-contact">
                            ${team.key_personnel_name} (${team.key_personnel_title || 'Contact'})
                            ${team.key_personnel_email ? `<br>üìß ${team.key_personnel_email}` : ''}
                            ${team.key_personnel_phone ? `<br>üìû ${team.key_personnel_phone}` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
    } else {
        html += `<p>No teams found yet for this state.</p>`;
    }
    
    html += `
        <div class="search-form">
            <h6>Start New Search</h6>
            <input type="text" id="search-query" class="search-input" 
                   placeholder="e.g., overdose response team, harm reduction" 
                   value="overdose response team">
            <button class="btn-start-search" onclick="startSearch('${data.state.abbreviation}')">
                Start Search for ${data.state.name}
            </button>
        </div>
    `;
    
    content.innerHTML = html;
}

function startSearch(stateCode) {
    const searchQuery = document.getElementById('search-query').value;
    const button = document.querySelector('.btn-start-search');
    
    button.disabled = true;
    button.textContent = 'Starting Search...';
    
    fetch(`/api/map/start-search/${stateCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            search_query: searchQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.textContent = 'Search Started!';
            button.style.background = '#28a745';
            
            // Redirect to job status page after a short delay
            setTimeout(() => {
                window.location.href = `/job/${data.job_id}`;
            }, 1500);
        } else {
            button.textContent = 'Error: ' + data.error;
            button.style.background = '#dc3545';
            setTimeout(() => {
                button.disabled = false;
                button.textContent = `Start Search for ${selectedState}`;
                button.style.background = '#28a745';
            }, 3000);
        }
    })
    .catch(error => {
        button.textContent = 'Error: ' + error.message;
        button.style.background = '#dc3545';
        setTimeout(() => {
            button.disabled = false;
            button.textContent = `Start Search for ${selectedState}`;
            button.style.background = '#28a745';
        }, 3000);
    });
}
</script>
{% endblock %}
